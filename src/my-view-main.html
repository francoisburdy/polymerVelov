<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/google-map/google-map-search.html">
<link rel="import" href="../bower_components/google-map/google-map-marker.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/iron-polling/iron-polling.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view-main">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 0px;
      }

      google-map {
        height: 100vh;
      }

      google-map-marker.update{
        transition: 0.5s;
        transform: scale(2,2);
        border:3px solid pink;
      }

      .card.bottom {
        position: fixed;
        bottom: 0.5rem;
        right: 1.3rem;
      }

      .card.top {
        position: fixed;
        top: 0.5rem;
        right: 1.3rem;
      }

      .empty{
        display: none;
      }

    </style>

    <iron-polling
      url="https://opendata.paris.fr/api/records/1.0/search/?dataset=stations-velib-disponibilites-en-temps-reel&rows={{maxRows}}&facet=status&geofilter.distance={{lat}}%2C{{long}}%2C{{resultsRadius}}"
      last-response="{{ajaxResponse}}"
      on-response="responseReceived"
      status="{{currentStatus}}"
      polling-frequency="{{pollingFrequency}}"
      handle-as="json">
    </iron-polling>
   
    <google-map-search 
      global-search="true"
      map="[[map]]" 
      query="{{mapCenterSearch}}" 
      on-google-map-search-results="searchResultsReceived"
      results="{{searchResults}}">
    </google-map-search>

    <google-map 
      id="idMap"
      map="{{map}}" latitude="" longitude="" 
      api-key="AIzaSyCMwoD7JpzLCf5VRKm1J9u8EPXAnTsLEg0"
      zoom="14" fit-to-markers>
        <template is="dom-repeat" items="[[ajaxResponse.records]]">
          <google-map-marker
            icon="{{iconUrl(item.fields.available_bike_stands,item.fields.last_update)}}"
            latitude="[[item.fields.position.0]]"
            class="{{emptyClass(item.fields.available_bike_stands)}}"
            hidden$="[[hideEmptyStation(item.fields.available_bike_stands)]]"
            longitude="[[item.fields.position.1]]">

            {{item.fields.available_bike_stands}}<br/>
            {{item.fields.last_update}}<br/>
 
            <p>[[isUpdated(item.fields.last_update)]]</p>
          </google-map-marker>
        </template>
    </google-map>


    <div class="card top text-center">
      <paper-spinner active></paper-spinner>
      <p id="msg-loading">{{currentStatus}}</p>
    </div>

    <div class="card bottom max-width-280">

      <iron-collapse id="collapse" opened>
        <div>
          <paper-input label="Point central des résultats" value="{{mapCenterSearch}}" class="full-width">
            <iron-icon icon="my-location" prefix></iron-icon>
          </paper-input>
          <paper-input label="Rayon des résultats (m)" value="{{resultsRadius}}" type="number" min=30 max=20000 class="full-width">
            <iron-icon icon="radius" prefix></iron-icon>
          </paper-input>
          <paper-input label="Nombre maximal de stations" value="{{maxRows}}" type="number" min=2 max=10000 class="full-width">
            <iron-icon icon="dots-number" prefix></iron-icon>
          </paper-input>
          <paper-toggle-button on-change="toggleHideEmpty" class="full-width">Cacher les stations vides</paper-toggle-button>
          <br />
          <paper-input label="Fréquence de polling (sec)" value="{{pollingFrequency}}" type="number" min=1 class="full-width">
            <iron-icon icon="timer" prefix></iron-icon>
          </paper-input>
        </div>
      </iron-collapse>

      <paper-icon-button icon="drop-down" class="float-right" on-click="toggleCollapse" id="toggleButton"></paper-icon-button>
      
    </div>

    <paper-toast id="toast0" text="Données mises à jour"></paper-toast>

  </template>

  <script>
      Polymer({
          is: 'my-view-main',
          properties: {
             currentStatus: {
                type: String,
                observer: '_currentStatusChanged'
             }
          },

          ready: function(){
             // --- Default settings ---
            this.maxRows = 5;
            this.resultsRadius = 10000;
            this.pollingFrequency = 10;
            this.mapCenterSearch = "Musée du Louvre";
            this.lat = 48.8;
            this.long = 2.3;
          },

          isUpdated: function(lastUpdate) {
            return (new Date(lastUpdate)) >= (this.lastPoll-150000) ? "update" : "not-update";
          },

          iconUrl: function(i, lastUpdate) {
            var char = i || '!';
              return this.isUpdated(lastUpdate) == "update" && i > 0 ? 
                  'https://raw.githubusercontent.com/Concept211/Google-Maps-Markers/master/images/marker_blue' + char + '.png' : 
                  i ? 'https://raw.githubusercontent.com/Concept211/Google-Maps-Markers/master/images/marker_green' + char + '.png' : 
                  null;
          },

          hideEmptyStation: function(n) {
            return n == 0 && this.hideEmpty;
          },

          toggleHideEmpty: function(){
            console.log("toggleHideEmpty", this.hideEmpty);
            this.hideEmpty = !this.hideEmpty;
          },

          toggleCollapse: function() {
            this.$.collapse.toggle();
            this.$.toggleButton.icon = this.$.toggleButton.icon == "drop-down" ? "drop-up" : "drop-down";
          },

          responseReceived: function(){
            console.log('searchResults', this.searchResults);
            this.$.toast0.open();
            this.lastPoll = new Date();
          }, 

          emptyClass: function(nb){
            return nb == 0 ? "empty" : "";
          },

          searchResultsReceived: function(){
            console.log('searchResults', this.searchResults);
            if(this.searchResults[0]){
              this.$.idMap.longitude = this.searchResults[0].longitude;
              this.$.idMap.latitude = this.searchResults[0].latitude;
              this.lat = this.searchResults[0].latitude;
              this.long = this.searchResults[0].longitude;
            } 
          },

          _currentStatusChanged: function(){
            console.log("currentStatus", this.currentStatus )
          }

      });
  </script>
</dom-module>
